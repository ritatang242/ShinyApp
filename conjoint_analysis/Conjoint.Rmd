---
title: "ç”¢å“è¨­è¨ˆèˆ‡å®šåƒ¹ç­–ç•¥"
output: 
  flexdashboard::flex_dashboard:
    theme: flatly
    social: menu # share to other in social media
    source_code: embed 
    favicon: nsysu48.png # browserä¸Štitleæ—é‚Šçš„å°logo
runtime: shiny
---

```{r}
require(magrittr)
require(shiny)
require(shinyWidgets)
require(shinythemes)
require(flexdashboard)
require(highcharter)
require(DT)
require(dplyr)

load("W2.rdata")
UT = function(v) rowSums(W[, c(1, v + c(1,4,7,10))])
PC = function(pd) {
  2.5 + sum(sapply(1:length(att), 
                   function(i) costs[[i]][pd[i]] )) }
costs = list(bitter =  c(0.3, 0.2, 0.1),
             variety = c(0.9, 0.5, 0.2),
             kind  =   c(0.5, 0.3, 0.6),
             arom =    c(0.7, 0.4) )
pqr = function(p, m, u, prob=FALSE) {
  if(prob) 
    q = colSums(sapply(p, function(x) 1/(1+exp(x-u)) )) 
  else  
    q = sapply(p, function(x) sum(u > x) )  # quantity
  pf = q * (p-m); ip = which.max(pf)        # profit
  r  = q * p;     ir = which.max(r)         # revenue
  
  par(mar=c(5,4,3,3),cex=1)
  plot(p,q,type='l',main="åƒ¹æ ¼åæ‡‰å‡½æ•¸(éœ€æ±‚æ›²ç·š)",
       xlab="åƒ¹æ ¼(Price)",ylab="æ•¸é‡(Qty)",font.lab=2,
       ylim=c(0,80),lwd=3, col="gold",
       family="è˜‹æ–¹-ç¹ ä¸­é»‘é«”")
  abline(v=p[ip],col='pink',lwd=2); abline(v=p[ir],col='cyan',lwd=2)
  abline(h=seq(20,80,20),lty=3,col='grey')
  plot(p, r, type='l',main="ç‡Ÿæ”¶å‡½æ•¸",ylab="",ylim=c(0,300),font.lab=2,
       lwd=3, col="gold", xlab=sprintf(
         "åƒ¹æ ¼=%.1f, æ•¸é‡=%.1f, ç‡Ÿæ”¶=%.1f, ç²åˆ©=%.1f", 
         p[ir], q[ir], r[ir], pf[ir] ),
       family="è˜‹æ–¹-ç¹ ä¸­é»‘é«”")
  abline(v=p[ir],col='cyan',lwd=2);
  abline(h=seq(50,250,50),lty=3,col='grey')
  plot(p, pf, type='l',main="ç²åˆ©å‡½æ•¸",ylab="",ylim=c(0,110),font.lab=2,
       lwd=3, col="gold", xlab=sprintf(
         "åƒ¹æ ¼=%.1f, æ•¸é‡=%.1f, ç‡Ÿæ”¶=%.1f, ç²åˆ©=%.1f",
         p[ip], q[ip], r[ip], pf[ip] ),
       family="è˜‹æ–¹-ç¹ ä¸­é»‘é«”"  )
  abline(v=p[ip],col='pink',lwd=2);
  abline(h=seq(20,100,20),lty=3,col='grey')
  text(9,100,sprintf("é‚Šéš›æˆæœ¬ = %.1f",m),pos=4,font=2)
}
att = apply(profiles,2,max)
attl = unlist(sapply(1:length(att), function(x) rep(x , att[x])))
```




åƒ¹é‡é—œä¿‚ {data-orientation=rows}
==========================================================

Input {.sidebar data-width=350px}
-------------------------------------

<h4>è¨­å®šç”¢å“å±¬æ€§</h4>
```{r}
hr()

chooseSliderSkin("Modern")

prettyRadioButtons(
  "A1", "è‹¦å‘³", 
  choices = list("ä½"=1, "ä¸­"=2, "é«˜"=3),
  selected = 1, inline=T, icon=icon("check"), 
  status="primary", animation="jelly")

hr()

prettyRadioButtons(
  "A2", "èŒ¶ç¨®", 
  choices = list("ç´…èŒ¶"=1, "ç¶ èŒ¶"=2, "åšå£«èŒ¶"=3),
  selected = 1, inline=T, icon=icon("check"), 
  status="primary", animation="jelly")

hr()

prettyRadioButtons(
  "A3", "åŒ…è£", 
  choices = list("èŒ¶åŒ…"=1, "èŒ¶æœ«"=2, "èŒ¶è‘‰"=3),
  selected = 1, inline=T, icon=icon("check"), 
  status="primary", animation="jelly")

hr()

prettyRadioButtons(
  "A4", "å¤–åŠ é¦™æ–™", 
  choices = list("ç„¡"=1, "æœ‰"=2),
  selected = 1, inline=T, icon=icon("check"), 
  status="primary", animation="jelly")

hr()

prettyRadioButtons(
  "Prob", "å¹³æ»‘éœ€æ±‚å‡½æ•¸", 
  choices = list("é—œé–‰"=0, "ä½¿ç”¨"=1),
  selected = 1, inline=T, icon=icon("check"), 
  status="primary", animation="jelly")

```


<img src="BAPlogo.png" alt="CM.NSYSU" width="80" height="80" align="left"></br>
<h6>[ä¸­å±±å¤§å­¸å•†æ¥­å¤§æ•¸æ“šå¹³å°](https://bap.cm.nsysu.edu.tw/)</h6>
<h6>å”æ€çª</h6>


Row { data-height=85% }
-------------------------------------
### 
```{r}
renderPlot({
 pd1 = as.integer(c(input$A1,input$A2,input$A3,input$A4)) # ç”¢å“è¨­è¨ˆ # inputå›å‚³æ˜¯å­—ä¸²å‹æ…‹æ‰€ä»¥è¦æ”¹
 ut1 = UT(pd1)
 hist(ut1)
 par(mfcol=c(2,2),mar=c(5,3,4,3),cex=1,
     family="è˜‹æ–¹-ç¹ ä¸­é»‘é«”")
 hist(ut1,-5:13,main="æ•ˆç”¨åˆ†ä½ˆ",xaxt='n',col='gray',
      border='white',xlab="æ•ˆç”¨(Utility)",ylab="",xlim=c(-4,14))
 axis(1,at=seq(-4,14,2))
 pqr(seq(2.5,11,0.1),PC(pd1),ut1,input$Prob == "1") # åƒ¹æ ¼ç¯„åœ
})
```

Row {.tabset .tabset-fade data-height=15%}
-------------------------------------
### ğŸš‘ ç·´ç¿’1
â–  ç”¨APWæ‰¾å‡ºä¾†çš„æœ€ä½³ç”¢å“è¦æ ¼ï¼Œå…¶æœ€ä½³åƒ¹æ ¼æ˜¯ï¼Ÿ <br>
â–  å®ƒæœƒå¸¶ä¾†å¤šå¤§çš„éŠ·å”®é‡ã€ç‡Ÿæ”¶å’Œç²åˆ©ï¼Ÿ

### ğŸš‘ ç·´ç¿’2
â–  è©¦è‘—ä½¿ç”¨æ¨¡æ“¬ç¨‹å¼ï¼Œæ‰¾å°‹å¯ä»¥ç”¢ç”Ÿæœ€å¤§ç²åˆ©å’Œç‡Ÿæ”¶çš„ç”¢å“è¦æ ¼å’Œåƒ¹æ ¼ï¼Ÿ <br>
â–  å®ƒæœƒå¸¶ä¾†å¤šå¤§çš„éŠ·å”®é‡ã€ç‡Ÿæ”¶å’Œç²åˆ©ï¼Ÿ

### ğŸš‘ ç·´ç¿’3
â–  å®ƒè·Ÿç”¨APWæ‰¾å‡ºä¾†çš„ç”¢å“è¦æ ¼å’Œæœ€ä½³åƒ¹æ ¼æ˜¯ä¸€æ¨£çš„å—ï¼Ÿ <br>
â–  é€™å€‹ç·´ç¿’çš„ç­–ç•¥æ„æ¶µæ˜¯ä»€éº¼ï¼Ÿ

æœ€ä½³ç­–ç•¥é¸é … {data-orientation=rows }
======================================================================
æˆ‘å€‘å¯ä»¥å¯«ä¸€æ®µç¨‹å¼ï¼ŒæŠŠæ‰€æœ‰å¯èƒ½çš„ç”¢å“`(3x3x3x2=54)`éƒ½æƒéä¸€éï¼Œ
å°‡å¯ä»¥ç”¢ç”Ÿæœ€å¤§ç‡Ÿæ”¶å’Œç²åˆ©çš„æœ€ä½³åƒ¹æ ¼éƒ½æ‰¾å‡ºä¾†ï¼Œ
æ”¾åœ¨åº•ä¸‹(`X`)é€™å€‹çŸ©é™£è£¡é¢ã€‚

Row
-------------------------------------
```{r}
pds = as.matrix(expand.grid(1:3,1:3,1:3,1:2))
X = t(apply(pds, 1, function (v) {
  c = PC(v)
  u = UT(v)
  X = t( sapply(seq(3,10,0.1), function (p) {
    q = sum(u > p)
    c(p, q, q * p, q * (p - c)) }) )
  c(mean(u), c, X[which.max(X[,3]),], X[which.max(X[,4]),])
}))
X = data.frame(cbind(pds,X))
colnames(X) = c('v1','v2','v3','v4',  # product spec
                'ut',                 # average utility of the product
                'cost',               # cost
                'p1','q1','r1','pf1', # price, quantity, revenue, profit at max. revenue
                'p2','q2','r2','pf2'  # price, quantity, revenue, profit at max. porfit
                )

renderDataTable({
 datatable(
   X %>% round(digits=1), extensions=c('Scroller'),
   # formatStyle(columns=0:2, fontSize = '90%'), 
   options=list(scrollY="350px",scrollX=F,paging=F,searching=F,info=F)
   )})

```


Row {.tabset .tabset-fade}
-----------------------------------------

### ğŸ’¡ æ¬„ä½å®šç¾©
+ `v1`~`v4`ï¼šä»£è¡¨å„å€‹ç”¢å“é¸é …ï¼ˆè‹¦å‘³ã€èŒ¶ç¨®ã€åŒ…è£ã€å¤–åŠ é¦™æ–™ï¼‰
+ `ut`ï¼šç”¢å“å°æ¶ˆè²»è€…çš„å¹³å‡æ•ˆç”¨
+ `cost`ï¼šç”¢å“çš„é‚Šéš›åƒ¹æ ¼
+ `p1,p2`ï¼šæœ€å¤§ç‡Ÿæ”¶(ç²åˆ©)ä¸‹çš„ç”¢å“åƒ¹æ ¼
+ `q1,q2`ï¼šæœ€å¤§ç‡Ÿæ”¶(ç²åˆ©)ä¸‹çš„éŠ·å”®é‡
+ `r1,r2`ï¼šæœ€å¤§ç‡Ÿæ”¶(ç²åˆ©)ä¸‹çš„ç‡Ÿæ”¶
+ `pf1,pf2`ï¼šæœ€å¤§ç‡Ÿæ”¶(ç²åˆ©)ä¸‹çš„ç²åˆ©

### ğŸš‘ ç·´ç¿’1
ç¾åœ¨ï¼Œåˆ©ç”¨ä¸‹é¢çš„è¡¨æ ¼é€²è¡Œæ’åºï¼š 
1. è«‹ä½ è©¦è‘—æ‰¾å‡ºæœ€å¤§ç‡Ÿæ”¶(`r1`)çš„ç”¢å“çµ„åˆç‚ºä½•ï¼Ÿ 
2. æœ€å¤§ç²åˆ©(`pf2`)çš„ç”¢å“å‘¢ï¼Ÿ

### ğŸš‘ ç·´ç¿’2
é€šå¸¸å…¬å¸çš„ç›®æ¨™éƒ½ä¸åªæ˜¯å°‡ç‡Ÿæ”¶ã€ç²åˆ©æœ€å¤§åŒ–é€™éº¼ç°¡å–®ã€‚ 
è«‹å•ï¼Œåœ¨`ä¸è™§æœ¬`çš„å‰æä¸‹ï¼Œ`æœ€å¤§ç‡Ÿæ”¶`çš„ç­–ç•¥æ˜¯ä»€éº¼ï¼Ÿ

### ğŸš‘ ç·´ç¿’3
è«‹å•ï¼Œåœ¨`æ»²é€ç‡30%`ä»¥ä¸Šçš„å‰æä¹‹ä¸‹ï¼Œ`æœ€å¤§ç²åˆ©`çš„ç­–ç•¥æ˜¯ä»€éº¼ï¼Ÿ

### ğŸ¯ å•é¡Œè¨è«– 
ç¾å¯¦çš„ç‹€æ³æ˜¯ï¼Œä½ å¸¸å¸¸éœ€è¦åœ¨ç›®æ¨™ä¸æ˜ç¢ºçš„ç‹€æ³ä¸‹åšç­–ç•¥è¦åŠƒï¼š

1. è«‹è©¦è‘—è‡ªå·±è¨­å®šç‡Ÿé‹ç›®æ¨™ï¼Œä¸¦æ‰¾åˆ°å¯¦ç¾é€™ä¸€å€‹ç›®æ¨™çš„æœ€ä½³ç­–ç•¥ 
2. ç„¶å¾Œè·Ÿå¤§å®¶åˆ†äº«ä½ çš„ç›®æ¨™å’Œç­–ç•¥ï¼Œå’Œå®ƒå€‘èƒŒå¾Œçš„é‚è¼¯  
3. æœ€å¾Œå†æƒ³çœ‹çœ‹ï¼Œè€é—†ç‚ºä»€éº¼å¸¸å¸¸ä¸å‘Šè¨´ä½ æ˜ç¢ºçš„ç›®æ¨™ï¼Œå°±å«ä½ åšç­–ç•¥è¦åŠƒå‘¢ï¼Ÿ


ç­–ç•¥ç©ºé–“ {data-orientation=column}
=====================================

Column {data-width=30%}
-------------------------------------

æ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘å°‡æ‰€æœ‰ç”¢å“çš„æœ€ä½³ç‡Ÿæ”¶å’Œç²åˆ©ä¸€èµ·ç•«åœ¨åŒä¸€å€‹å¹³é¢ä¸Š(å¦‚å³åœ–) 

### ğŸš‘ ç·´ç¿’1  {data-height=15%}
è«‹æª¢è¨ä¸€ä¸‹ä½ çš„ç­–ç•¥ï¼Œä½ æœƒæƒ³è¦èª¿æ•´ç­–ç•¥å—ï¼Ÿå¦‚ä½•èª¿æ•´å‘¢ï¼Ÿ

### ğŸš‘ ç·´ç¿’2  {data-height=15%}
åœ¨å¤šé‡ç›®æ¨™çš„æƒ…å¢ƒä¹‹ä¸‹ï¼Œä»€éº¼æ¨£çš„ç­–ç•¥æ‰æ˜¯åˆç†çš„ç­–ç•¥ï¼Ÿ 
åˆç†çš„ç­–ç•¥è¦æœ‰ä»€éº¼æ¢ä»¶å‘¢ï¼Ÿ 

### ğŸš‘ ç·´ç¿’3  {data-height=15%}
ä½ å¯ä»¥åœ–ä¸­è¾¨è­˜å‡ºå“ªä¸€äº›æ˜¯ç”¢å“æ˜¯ã€Œåˆç†ã€çš„å—ï¼Ÿ

### ğŸ¯ å­¸ç¿’é‡é»ï¼š  {data-height=20%}

1. ã€æ±ºå®šç­–ç•¥ç›®æ¨™ã€é€šå¸¸æ¯”ã€æ‰¾å‡ºæœ€ä½³ç­–ç•¥ã€å›°é›£
2. å¸‚å ´æ¨¡æ“¬å’Œè¦–è¦ºåŒ–å·¥å…·å¯ä»¥å¹«æˆ‘å€‘çœ‹åˆ°æ‰€æœ‰ç­–ç•¥é¸é …å’Œçµæœ
3. çœ‹åˆ°æ•´å€‹ç­–ç•¥ç©ºé–“ï¼Œæœ‰åŠ©æ–¼è¨­å®šç­–ç•¥ç›®æ¨™

### {data-height=35%}
 
<img src="BAPlogo.png" alt="CM.NSYSU" width="80" height="80" align="left"></br>
<h6>[ä¸­å±±å¤§å­¸å•†æ¥­å¤§æ•¸æ“šå¹³å°](https://bap.cm.nsysu.edu.tw/)</h6>
<h6>å”æ€çª</h6>


Column { data-width=70%}
-------------------------------------

### 
```{r}
df = data.frame(revenue=c(X$r1,X$r2),profit=c(X$pf1,X$pf2),
                p=c(X$p1,X$p2),q=c(X$q1,X$q2),
                opt=c(rep('opt.revenue',nrow(X)),rep('opt.profit',nrow(X))),
                lab=rep(apply(X[,1:4],1,paste0,collapse=''),2)  )
hchart(df, "scatter", hcaes(x=revenue, y=profit, group=opt, lab, p, q)) %>%
  hc_plotOptions(series=list(allowPointSelect=T)) %>%
  hc_chart(zoomType = "xy") %>% hc_add_theme(hc_theme_flat()) %>%
  hc_tooltip(headerFormat = "",valueDecimals=1,borderWidth=2,
    hideDelay=100,useHTML=T,padding=3,
    pointFormat="<center><b>({point.lab})</b></center> price: {point.p}<br>
                 qty: {point.q}<br> RV: {point.x}<br> PF: {point.y}") %>%
  hc_colors(hex_to_rgba(c('darkgreen','orange'), alpha = 0.65)) %>%
  hc_legend(floating=T,align='left',verticalAlign='bottom')
```

